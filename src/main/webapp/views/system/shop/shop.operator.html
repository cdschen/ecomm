<ol class="breadcrumb">
    <li><a ui-sref="dashboard">首页</a></li>
    <li><a ui-sref="shop">店铺管理</a></li>
    <li class="active">创建店铺</li>
</ol>
<div class="container-fluid">
    <div class="panel panel-default">
        <div class="panel-body">
            <h4>店铺基本信息</h4>
            <hr>
            <!-- form -->
            <form name="shopOperatorForm" class="form-horizontal" role="form" novalidate ng-submit="saveShop(shop)">
                <!-- name -->
                <div class="form-group has-feedback" ng-class="{'has-success':(shopOperatorForm.name.$dirty && shopOperatorForm.name.$valid), 'has-warning':(shopOperatorForm.name.$dirty && shopOperatorForm.name.$invalid) }">
                    <label class="control-label col-md-2" for="name">店铺名称 <span class="text-danger">*</span></label>
                    <div class="col-md-5">
                        <input type="text" class="form-control" id="name" name="name" ng-model="shop.name" placeholder="店铺名称" required ng-maxlength="50" />
                        <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="shopOperatorForm.name.$dirty && shopOperatorForm.name.$valid"></span>
                        <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="shopOperatorForm.name.$dirty && shopOperatorForm.name.$invalid"></span>
                    </div>
                    <span class="col-md-5 help-block" ng-messages="shopOperatorForm.name.$error" ng-show="shopOperatorForm.name.$dirty && shopOperatorForm.name.$invalid">
                        <span ng-messages-include="views/error-messages.html?1" ></span>
                    </span>
                </div>
                <!-- token -->
                <div class="form-group has-feedback" ng-class="{'has-success':(shopOperatorForm.token.$dirty && shopOperatorForm.token.$valid), 'has-warning':(shopOperatorForm.token.$dirty && shopOperatorForm.token.$invalid) }">
                    <label class="control-label col-md-2" for="token">店铺Token <span class="text-danger">*</span></label>
                    <div class="col-md-5">
                        <input type="text" class="form-control" id="token" name="token" ng-model="shop.token" placeholder="店铺名称" required ng-maxlength="50" />
                        <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="shopOperatorForm.token.$dirty && shopOperatorForm.token.$valid"></span>
                        <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="shopOperatorForm.token.$dirty && shopOperatorForm.token.$invalid"></span>
                    </div>
                    <span class="col-md-5 help-block" ng-messages="shopOperatorForm.token.$error" ng-show="shopOperatorForm.token.$dirty && shopOperatorForm.token.$invalid">
                        <span ng-messages-include="views/error-messages.html?1" ></span>
                    </span>
                </div>
                <!-- type -->
                <div class="form-group has-feedback">
                    <label class="control-label col-md-2" for="type">店铺类型 <span class="text-danger">*</span></label>
                    <div class="col-md-5">
                        <select class="form-control" ng-model="shop.type" ng-options="type.id as type.label for type in types" id="type" name="type">
                        </select>
                    </div>
                </div>
                <!-- status -->
                <div class="form-group has-feedback">
                    <label class="control-label col-md-2" for="status">店铺状态 <span class="text-danger">*</span></label>
                    <div class="col-md-5">
                        <select class="form-control" ng-model="shop.status" ng-options="status.id as status.label for status in statuses" id="status" name="status">
                        </select>
                    </div>
                </div>
                <!-- admin_id -->
                <div class="form-group has-feedback" ng-class="{'has-success':(shopOperatorForm.admin_id.$dirty && shopOperatorForm.admin_id.$valid), 'has-warning':(shopOperatorForm.admin_id.$dirty && shopOperatorForm.admin_id.$invalid) }">
                    <label class="control-label col-md-2" for="admin_id">店铺管理员 <span class="text-danger">*</span></label>
                    <div class="col-md-5">
                        <select class="form-control" ng-model="shop.user.id" id="admin_id" name="admin_id" required>
                            <option ng-repeat="user in users" value="{{user.id}}" ng-selected="shop.user.id == user.id">{{user.username}}</option>
                        </select>
                    </div>
                    <!-- <span class="col-md-5 help-block" ng-messages="shopOperatorForm.admin_id.$error" ng-show="shopOperatorForm.admin_id.$dirty && shopOperatorForm.admin_id.$invalid">
                        <span ng-messages-include="views/error-messages.html?1" ></span>
                    </span> -->
                </div>
                <!-- api_call_limit -->
                <div class="form-group has-feedback" ng-class="{'has-success':(shopOperatorForm.api_call_limit.$dirty && shopOperatorForm.api_call_limit.$valid), 'has-warning':(shopOperatorForm.api_call_limit.$dirty && shopOperatorForm.api_call_limit.$invalid) }">
                    <label class="control-label col-md-2" for="api_call_limit">API 调用次数限制 <span class="text-danger">*</span></label>
                    <div class="col-md-5">
                        <input type="number" class="form-control" id="api_call_limit" name="api_call_limit" ng-model="shop.apiCallLimit" placeholder="API 调用次数限制" required ng-maxlength="6" />
                        <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="shopOperatorForm.api_call_limit.$dirty && shopOperatorForm.api_call_limit.$valid"></span>
                        <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="shopOperatorForm.api_call_limit.$dirty && shopOperatorForm.api_call_limit.$invalid"></span>
                    </div>
                    <span class="col-md-5 help-block" ng-messages="shopOperatorForm.api_call_limit.$error" ng-show="shopOperatorForm.api_call_limit.$dirty && shopOperatorForm.api_call_limit.$invalid">
                        <span ng-messages-include="views/error-messages.html" ></span>
                    </span>
                </div>
                <!-- language_id -->
                <div class="form-group has-feedback">
                    <label class="control-label col-md-2" for="language_id">店铺显示语言 <span class="text-danger">*</span></label>
                    <div class="col-md-5">
                        <select class="form-control" ng-model="shop.language.id" id="language_id" name="language_id">
                            <option ng-repeat="language in languages" value="{{language.id}}" ng-selected="shop.language.id == language.id">{{language.name}}, {{language.code}}</option>
                        </select>
                    </div>
                </div>
                <!-- currency_id -->
                <div class="form-group has-feedback">
                    <label class="control-label col-md-2" for="currency_id">店铺结算货币 <span class="text-danger">*</span></label>
                    <div class="col-md-5">
                        <select class="form-control" ng-model="shop.currency.id" ng-options="currency.id as currency.name for currency in currencies" id="currency_id" name="currency_id">
                        </select>
                    </div>
                </div>
                <!-- price_level -->
                <div class="form-group has-feedback">
                    <label class="control-label col-md-2" for="price_level">店铺价格等级 <span class="text-danger">*</span></label>
                    <div class="col-md-5">
                        <select class="form-control" ng-model="shop.priceLevel" ng-options="lvl.id as lvl.label for lvl in lvls" id="price_level" name="price_level">
                        </select>
                    </div>
                </div>
                <!-- button -->
                <div class="form-group">
                    <div class="col-md-5 col-md-offset-2">
                        <button type="submit" class="btn btn-success btn-lg" ng-disabled="!shopOperatorForm.$valid">保存</button>
                        <button type="button" class="btn btn-danger btn-lg" ng-click="remove()" ng-if="action=='update'">删除</button>
                    </div>
                </div>
            </form>
            <hr>
            <h4>店铺的配货方式</h4>
            <hr> 
            <form name="tunnelForm" novalidate ng-repeat="tunnel in shop.tunnels">
                <!-- tunnel table -->
                <table class="table table-condensed table-striped clear-marginbottom-table">
                    <thead ng-show="$first">
                        <tr>
                            <th width="15%">名称</th>
                            <th width="15%">类型</th>
                            <th width="15%">行为</th>
                            <th width="15%">默认方式</th>
                            <th width="30%"></th>
                            <th width="10%">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td width="15%">
                                <span ng-show="!tunnel.editable">{{tunnel.name}}</span>
                                <div ng-show="tunnel.editable" class="form-group has-feedback" ng-class="{'has-success':(tunnelForm.name.$dirty && tunnelForm.name.$valid), 'has-warning':(tunnelForm.name.$dirty && tunnelForm.name.$invalid) }">
                                    <input type="text" name="name" ng-model="tunnel.name" placeholder="名称(必填)" class="form-control" required ng-maxlength="50" />
                                    <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="tunnelForm.name.$dirty && tunnelForm.name.$valid"></span>
                                    <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="tunnelForm.name.$dirty && tunnelForm.name.$invalid"></span>
                                </div>
                            </td>
                            <td width="15%">
                                <span ng-show="!tunnel.editable">{{tunnel.type.label}}</span>
                                <span ng-show="tunnel.editable">
                                    <ui-select ng-model="tunnel.type">
                                        <ui-select-match placeholder="类型(必选)">{{$select.selected.label}}</ui-select-match>
                                        <ui-select-choices repeat="type in tunnelTypes | filter: $select.search">
                                            <div ng-bind-html="type.label | highlight: $select.search"></div>
                                        </ui-select-choices>
                                    </ui-select>
                                </span>
                            </td>
                            <td width="15%">
                                <span ng-show="!tunnel.editable">{{tunnel.behavior.label}}</span>
                                <span ng-show="tunnel.editable">
                                    <ui-select ng-model="tunnel.behavior">
                                        <ui-select-match placeholder="行为(必选)">{{$select.selected.label}}</ui-select-match>
                                        <ui-select-choices repeat="behavior in tunnelBehaviors | filter: $select.search">
                                            <div ng-bind-html="behavior.label | highlight: $select.search"></div>
                                        </ui-select-choices>
                                    </ui-select>
                                </span>
                            </td>
                            <td width="15%">
                                <span ng-show="!tunnel.editable">{{tunnel.defaultOption.label}}</span>
                                <span ng-show="tunnel.editable">
                                    <ui-select ng-model="tunnel.defaultOption">
                                        <ui-select-match placeholder="是否为默认(必选)">{{$select.selected.label}}</ui-select-match>
                                        <ui-select-choices repeat="option in tunnelDefaultOptions | filter: $select.search">
                                            <div ng-bind-html="option.label | highlight: $select.search"></div>
                                        </ui-select-choices>
                                    </ui-select>
                                </span>
                            </td>
                            <td width="30%">
                                <span ng-show="!tunnel.editable && tunnel.type.value == 1">
                                    <span ng-repeat="warehouse in tunnel.warehouses" class="label label-default" style="margin:3px">{{warehouse.name}}</span>
                                </span>
                                <span ng-show="!tunnel.editable && tunnel.type.value == 2">
                                    <span ng-repeat="supplier in tunnel.suppliers" class="label label-info" style="margin:3px">{{supplier.name}}</span>
                                </span>
                                <span ng-show="tunnel.editable">
                                    <ui-select ng-model="tunnel.warehouses" multiple ng-show="tunnel.type.value == 1" ng-disabled="disabled" sortable="true" close-on-select="false">
                                        <ui-select-match placeholder="仓库(必选)">{{$item.name}}</ui-select-match>
                                        <ui-select-choices repeat="warehouse in warehouses | filter: $select.search">
                                            <div ng-bind-html="warehouse.name | highlight: $select.search"></div>
                                        </ui-select-choices>
                                    </ui-select>
                                    <ui-select ng-model="tunnel.suppliers" multiple ng-show="tunnel.type.value == 2" ng-disabled="disabled" sortable="true" close-on-select="false">
                                        <ui-select-match placeholder="仓库(必选)">{{$item.name}}</ui-select-match>
                                        <ui-select-choices repeat="supplier in suppliers | filter: $select.search">
                                            <div ng-bind-html="supplier.name | highlight: $select.search"></div>
                                        </ui-select-choices>
                                    </ui-select>
                                </span>
                            </td>
                            <td width="10%">
                                <button type="button" class="btn btn-success" ng-click="saveUpdateTunnel(tunnel, tunnelForm, $index)" ng-show="tunnel.editable" ng-disabled="!tunnelForm.name.$valid">
                                    <span class="glyphicon glyphicon-floppy-saved"></span>
                                </button>
                                <button type="button" class="btn btn-info" ng-click="updateTunnel(tunnel, $index)" ng-show="!tunnel.editable">
                                    <span class="glyphicon glyphicon-edit"></span>
                                </button>
                                <button type="button" class="btn btn-danger" ng-click="showRemoveTunnel(tunnel, $index)">
                                    <span class="glyphicon glyphicon-trash"></span>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </form>
            <!-- tunnel add form -->
            <form name="tunnelAddForm" novalidate ng-submit="saveTunnel(tunnelAddForm, tunnel)">
                <table class="table table-condensed clear-marginbottom-table">
                    <tbody>
                        <tr>
                            <td width="15%">
                                <!-- tunnel.name -->
                                <div class="form-group has-feedback" ng-class="{'has-success':(tunnelAddForm.name.$dirty && tunnelAddForm.name.$valid), 'has-warning':(tunnelAddForm.name.$dirty && tunnelAddForm.name.$invalid) }">
                                    <input type="text" name="name" ng-model="tunnel.name" placeholder="配货名称(必填)" class="form-control" required min="1" ng-maxlength="50" />
                                    <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="tunnelAddForm.name.$dirty && tunnelAddForm.name.$valid"></span>
                                    <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="tunnelAddForm.name.$dirty && tunnelAddForm.name.$invalid"></span>
                                </div>
                            </td>
                            <td width="15%">
                                <ui-select ng-model="tunnel.type">
                                    <ui-select-match placeholder="类型(必选)">{{$select.selected.label}}</ui-select-match>
                                    <ui-select-choices repeat="type in tunnelTypes | filter: $select.search">
                                        <div ng-bind-html="type.label | highlight: $select.search"></div>
                                    </ui-select-choices>
                                </ui-select>
                            </td>
                            <td width="15%">
                                <ui-select ng-model="tunnel.behavior">
                                    <ui-select-match placeholder="行为(必选)">{{$select.selected.label}}</ui-select-match>
                                    <ui-select-choices repeat="behavior in tunnelBehaviors | filter: $select.search">
                                        <div ng-bind-html="behavior.label | highlight: $select.search"></div>
                                    </ui-select-choices>
                                </ui-select>
                            </td>
                            <td width="15%">
                                <ui-select ng-model="tunnel.defaultOption">
                                    <ui-select-match placeholder="是否为默认(必选)">{{$select.selected.label}}</ui-select-match>
                                    <ui-select-choices repeat="option in tunnelDefaultOptions | filter: $select.search">
                                        <div ng-bind-html="option.label | highlight: $select.search"></div>
                                    </ui-select-choices>
                                </ui-select>
                            </td>
                            <td width="30%">
                                <ui-select ng-model="tunnel.warehouses" multiple ng-show="tunnel.type.value == 1" ng-disabled="disabled" sortable="true" close-on-select="false">
                                    <ui-select-match placeholder="仓库(必选)">{{$item.name}}</ui-select-match>
                                    <ui-select-choices repeat="warehouse in warehouses | filter: $select.search">
                                        <div ng-bind-html="warehouse.name | highlight: $select.search"></div>
                                    </ui-select-choices>
                                </ui-select>
                                <ui-select ng-model="tunnel.suppliers" multiple ng-show="tunnel.type.value == 2" ng-disabled="disabled" sortable="true" close-on-select="false">
                                    <ui-select-match placeholder="供应商(必选)">{{$item.name}}</ui-select-match>
                                    <ui-select-choices repeat="supplier in suppliers | filter: $select.search">
                                        <div ng-bind-html="supplier.name | highlight: $select.search"></div>
                                    </ui-select-choices>
                                </ui-select>
                            </td>
                            <td width="10%">
                                <button type="submit" class="btn btn-success" ng-disabled="!tunnelAddForm.$valid || !tunnel.type || !tunnel.behavior || !tunnel.defaultOption">添加</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </form>
        </div>
    </div>
</div>
<!-- tunnel delete Modal -->
<div class="modal fade" id="tunnelDeleteModal">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title text-danger">
                    <span class="glyphicon glyphicon-question-sign"></span> 确定删除
                </h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" ng-click="removeTunnel()">确定</button>
            </div>
        </div>
    </div>
</div>

